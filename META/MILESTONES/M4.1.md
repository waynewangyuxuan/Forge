# M4.1: Git Operations Module

> Config-driven git operations infrastructure

## 背景

当前问题：
- Scaffold 生成后文件未 commit 到 git
- Git 操作分散在各处，没有统一管理
- 无法配置 commit/push 行为

## 目标

建立 data-driven 的 Git 操作模块，支持：
- 声明式定义 git 操作时机和行为
- 统一的 Git adapter 接口
- 可配置的 commit/push 策略

## 交付物

### 1. Config Layer

**`config/git-operations.yaml`**
```yaml
# Git operation hooks - declarative git actions
hooks:
  scaffold_complete:
    commit:
      message: "chore(scaffold): generate task breakdown"
      files: ["META/"]
    push: auto  # auto | manual | disabled

  spec_save:
    commit:
      message: "docs: update spec files"
      files: ["META/CORE/"]
    push: manual

  execute_milestone:
    commit:
      message: "feat: complete {{milestone_name}}"
      files: ["."]
    push: auto

defaults:
  push_strategy: auto  # Can be overridden in Settings
  commit_author: forge  # Use git config or "forge"
```

### 2. Git Adapter

**`src/shared/interfaces/adapters.ts`** - 添加 IGitAdapter
```typescript
export interface IGitAdapter {
  // Basic operations
  status(repoPath: string): Promise<GitStatus>
  add(repoPath: string, files: string[]): Promise<void>
  commit(repoPath: string, message: string): Promise<string> // returns commit hash
  push(repoPath: string): Promise<void>

  // Branch operations
  getCurrentBranch(repoPath: string): Promise<string>
  createBranch(repoPath: string, name: string): Promise<void>
  checkout(repoPath: string, branch: string): Promise<void>

  // Info
  isRepo(path: string): Promise<boolean>
  hasRemote(repoPath: string): Promise<boolean>
}

export interface GitStatus {
  staged: string[]
  unstaged: string[]
  untracked: string[]
  branch: string
  ahead: number
  behind: number
}
```

**`src/main/infrastructure/adapters/git-adapter.ts`** - 实现
- 基于 `simple-git` 或直接调用 git CLI
- 处理错误情况（not a repo, no remote, etc.）

### 3. Git Operations Engine

**`src/main/domain/engines/git-operations.ts`**
```typescript
export interface GitHookContext {
  projectPath: string
  versionName?: string
  milestoneName?: string
  // ... other template variables
}

export function loadGitHooksConfig(): GitHooksConfig
export async function executeGitHook(
  hookName: string,
  context: GitHookContext,
  git: IGitAdapter
): Promise<GitHookResult>
```

### 4. 集成到 Use Cases

**`generate-scaffold.ts`** - Phase 5.5: Git commit
```typescript
// After writing files, before updating status
emitProgress({ versionId, message: 'Committing scaffold files...' })
await executeGitHook('scaffold_complete', {
  projectPath: project.path,
  versionName: version.versionName,
}, gitAdapter)
```

### 5. Settings UI 集成

在 Settings 页面添加 Git 配置：
- Push strategy: Auto / Manual / Disabled
- Commit on scaffold: Yes / No
- Commit on milestone: Yes / No

## 文件结构

```
src/
├── shared/
│   └── interfaces/
│       └── adapters.ts          # 添加 IGitAdapter
├── main/
│   ├── infrastructure/
│   │   ├── adapters/
│   │   │   └── git-adapter.ts   # NEW: Git adapter 实现
│   │   └── config-loader.ts     # 添加 loadGitHooksConfig
│   ├── domain/
│   │   └── engines/
│   │       └── git-operations.ts # NEW: Git 操作引擎
│   └── application/
│       └── use-cases/
│           └── scaffold/
│               └── generate-scaffold.ts # 集成 git hook
config/
└── git-operations.yaml          # NEW: Git 操作配置
```

## 验收标准

- [x] Scaffold 生成后自动 commit 到 git
- [x] Commit message 符合配置模板
- [x] Settings 中可配置 push 策略
- [x] Git 错误有清晰的用户提示
- [x] 单元测试覆盖 git adapter 和 engine

## 依赖

- M4 基础完成（scaffold generation 可用）

## 预计工作量

- Config + Types: 0.5h
- Git Adapter: 1h
- Git Engine: 1h
- Use Case 集成: 0.5h
- Settings UI: 0.5h
- Tests: 1h
- **Total: ~4.5h**
