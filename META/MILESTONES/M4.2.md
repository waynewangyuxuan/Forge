# M4.2: System Logger Infrastructure

> Unified logging for development debugging and user activity visibility

## 背景

当前问题：
- 日志分散使用 `console.log/error`
- 开发时难以追踪问题
- 用户不知道 Forge 在做什么（如 scaffold 生成过程）
- 没有日志持久化

## 目标

建立两层日志系统：
1. **System Logger** - 开发调试用，结构化、可持久化
2. **Activity Feed** - 用户可见，实时展示 Forge 活动

## 交付物

### 1. System Logger

**`src/main/infrastructure/logger/index.ts`**
```typescript
export interface Logger {
  debug(module: string, message: string, context?: object): void
  info(module: string, message: string, context?: object): void
  warn(module: string, message: string, context?: object): void
  error(module: string, message: string, context?: object): void
}

// Usage:
// logger.debug('scaffold', 'Parsing PRODUCT.md', { versionId })
// logger.info('ipc', 'Handler registered', { channel: 'project:create' })
// logger.error('db', 'Query failed', { error, sql })
```

**特性：**
- 输出到文件: `~/Library/Logs/Forge/forge-{date}.log`
- 开发模式额外输出到 console（带颜色）
- 结构化 JSON 格式，方便分析
- 日志级别通过环境变量控制: `FORGE_LOG_LEVEL=debug`
- 自动轮转（保留 7 天）

**日志格式：**
```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "info",
  "module": "scaffold",
  "message": "Scaffold generation started",
  "context": { "versionId": "ver-123", "projectName": "kindle-anki" }
}
```

### 2. Activity Feed

**`src/main/infrastructure/activity/index.ts`**
```typescript
export interface ActivityEvent {
  id: string
  timestamp: string
  type: ActivityType
  message: string
  icon?: string  // For UI display
  details?: object
}

export type ActivityType =
  | 'scaffold:start' | 'scaffold:progress' | 'scaffold:complete' | 'scaffold:error'
  | 'git:commit' | 'git:push'
  | 'claude:start' | 'claude:complete'
  | 'system:info' | 'system:warn' | 'system:error'

export interface ActivityFeed {
  emit(type: ActivityType, message: string, details?: object): void
  getRecent(limit?: number): ActivityEvent[]
  subscribe(callback: (event: ActivityEvent) => void): () => void
}
```

**特性：**
- 内存 ring buffer（最近 100 条）
- IPC 推送到 renderer
- 人类可读格式
- 带图标/颜色分类

### 3. IPC Integration

**`src/shared/types/ipc.types.ts`** - 添加
```typescript
// Activity event pushed from main to renderer
'activity:event': { input: never; output: ActivityEvent }
```

### 4. Renderer Store

**`src/renderer/stores/activity.store.ts`**
```typescript
interface ActivityState {
  events: ActivityEvent[]
  addEvent: (event: ActivityEvent) => void
  clearEvents: () => void
}
```

### 5. UI Components

**Option A: Status Bar Integration**
- 底部状态栏显示最新活动
- 点击展开活动面板

**Option B: Activity Panel**
- 侧边栏或 modal 显示活动列表
- 按时间倒序
- 可过滤类型

### 6. 替换现有 console.log

搜索并替换所有 `console.log/error`：
```typescript
// Before
console.error('Failed to fetch settings:', error)

// After
logger.error('settings', 'Failed to fetch settings', { error })
activity.emit('system:error', 'Failed to load settings')
```

## 文件结构

```
src/
├── main/
│   └── infrastructure/
│       ├── logger/
│       │   ├── index.ts         # Logger 接口和实现
│       │   └── file-transport.ts # 文件写入
│       └── activity/
│           └── index.ts         # Activity feed
├── renderer/
│   ├── stores/
│   │   └── activity.store.ts    # Activity 状态
│   └── components/
│       └── layout/
│           └── ActivityPanel/   # 活动面板组件
└── shared/
    └── types/
        └── activity.types.ts    # 共享类型
```

## 验收标准

- [ ] System logger 输出到文件和 console
- [ ] Activity feed 实时显示在 UI
- [ ] 所有 console.log/error 替换为 logger
- [ ] Scaffold 生成过程有清晰的活动提示
- [ ] 日志文件自动轮转
- [ ] 开发时可通过 LOG_LEVEL 控制日志级别

## 依赖

- 无强依赖，可独立开发

## 预计工作量

- Logger 核心: 1h
- File transport: 0.5h
- Activity feed: 1h
- IPC + Store: 0.5h
- UI Component: 1h
- 替换现有 console: 1h
- Tests: 1h
- **Total: ~6h**

## 技术选型

考虑的库：
- `electron-log` - Electron 专用，功能完整
- `winston` - 通用但需要配置
- `pino` - 高性能但偏 server-side
- **推荐**: 自定义轻量实现，满足需求即可
