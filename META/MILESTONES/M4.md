# M4: Scaffold 生成

> **目标**：实现 Spec → TODO.md + CLAUDE.md 的 AI 生成

**状态**: completed
**依赖**: M3

---

## 架构决策

基于 M4 开发前的咨询反馈，做出以下决策：

| 决策 | 选择 | 原因 |
|------|------|------|
| AI 输出格式 | **JSON** | 比 Markdown 更易解析和验证 |
| 文件拆分 | **代码处理** | 不依赖 AI 创建文件，更可控 |
| 文档分层 | **索引 + 详情** | 执行时按需加载，节省 context |
| 执行协议 | **显式步骤** | 确保 Claude Code 按需读取文件 |

## 输出文件结构

```
META/
├── CLAUDE.md           # 执行入口（~800 tokens）
├── TODO.md             # 任务索引（~1K tokens）
├── MILESTONES/         # 按 Milestone 分文件
│   ├── M1-*.md
│   ├── M2-*.md
│   └── ...
└── CONTEXT/            # 执行时按需加载
    ├── architecture.md
    └── conventions.md
```

---

## 交付物

### 后端

- [x] ClaudeCliAdapter（调用 Claude Code CLI）
  - `src/main/infrastructure/adapters/claude.adapter.ts`
- [x] Domain Engines
  - [x] PromptRenderer（渲染 prompt 模板） - `src/main/domain/engines/prompt-renderer.ts`
  - [x] ScaffoldValidator（验证 JSON 结构） - `src/main/domain/engines/scaffold-validator.ts`
  - [x] ScaffoldWriter（JSON → 文件） - `src/main/domain/engines/scaffold-writer.ts`
- [x] Config 文件
  - [x] `config/prompts/scaffold-generator.yaml`
  - [x] `config/templates/claude-md.template.md`
- [x] Scaffold Use Cases
  - [x] `src/main/application/use-cases/scaffold/generate-scaffold.ts`
- [x] scaffold:* IPC 事件发送
  - `src/main/infrastructure/ipc/scaffold.ipc.ts`

### 前端

- [x] RealtimeStore scaffold 订阅 - 已在 M3 实现
- [x] SpecPage "Generate Scaffold" 按钮
- [x] 生成进度展示（Modal + 流式消息）
- [x] 生成完成后自动跳转 ReviewPage

---

## 验收标准

- [x] 点击 Generate 后能看到实时进度消息
- [x] 生成完成后 TODO.md 出现在 META/
- [x] 生成完成后 CLAUDE.md 出现在 META/
- [x] 生成完成后 MILESTONES/*.md 出现在 META/
- [x] 生成完成后 CONTEXT/*.md 出现在 META/
- [x] Version 状态从 `drafting` → `scaffolding` → `reviewing`
- [x] 生成失败时显示错误信息
- [x] Claude CLI 不可用时有明确提示

---

## IPC 通道

| 类型 | 通道 | 说明 |
|------|------|------|
| Invoke | `scaffold:generate` | 触发生成 |
| Invoke | `scaffold:checkClaudeAvailable` | 检查 Claude CLI 可用性 |
| Event | `scaffold:progress` | 进度消息 |
| Event | `scaffold:completed` | 生成完成 |
| Event | `scaffold:error` | 生成出错 |

---

## 状态流转

```
drafting ──[GENERATE_SCAFFOLD]──► scaffolding ──[SCAFFOLD_SUCCESS]──► reviewing
                                       │
reviewing ──[REGENERATE]──────────────►│
                                       │
                                       └──[SCAFFOLD_ERROR]──► error
```

> 注意：错误时转入 `error` 状态（非 `drafting`），符合 YAML 状态机定义。

---

## 手动测试清单

### 1. Happy Path - Scaffold 生成
```
1. 创建新项目（或使用已有项目）
2. 进入 Spec 页面
3. 填写 PRODUCT.md 和 TECHNICAL.md
4. 点击 "Generate Scaffold"
5. 验证：
   - [ ] 进度 Modal 显示状态消息
   - [ ] 状态转换: drafting → scaffolding → reviewing
   - [ ] 成功后 Modal 关闭
   - [ ] META/TODO.md 已创建
   - [ ] META/MILESTONES/*.md 已创建
   - [ ] META/CONTEXT/*.md 已创建
   - [ ] META/CLAUDE.md 已创建
```

### 2. 错误处理 - 缺少 Spec
```
1. 创建新项目
2. PRODUCT.md 保持为空
3. 点击 "Generate Scaffold"
4. 验证：
   - [ ] 显示清晰的错误信息
   - [ ] 状态保持在 "drafting"（未进入 scaffolding）
```

### 3. 错误处理 - Claude 不可用
```
1. 确保 Claude CLI 不可用
2. 尝试生成 scaffold
3. 验证：
   - [ ] 错误显示 "Claude CLI not available"（或类似）
   - [ ] 错误代码在 UI 中可见（如适用）
   - [ ] 状态正确回退
```

### 4. 从 Review 状态重新生成
```
1. 完成一次成功的 scaffold 生成
2. 在 "reviewing" 状态下点击 "Regenerate"
3. 验证：
   - [ ] Scaffold 重新生成成功
   - [ ] 旧文件被覆盖
   - [ ] 状态转换: reviewing → scaffolding → reviewing
```

### 5. 订阅清理（内存泄漏修复）
```
1. 开始生成 scaffold
2. 在进行中时，离开 Spec 页面
3. 返回 Spec 页面
4. 再次尝试生成
5. 验证：
   - [ ] 没有重复的进度事件
   - [ ] Modal 正常工作
   - [ ] 控制台无订阅相关错误
```

### 6. 错误后状态持久化
```
1. 在 scaffold 生成期间触发错误
2. 关闭并重新打开应用
3. 验证：
   - [ ] 项目显示正确状态（error）
   - [ ] 可以重试生成
```

---

## AI 输出 JSON Schema

```typescript
interface ScaffoldOutput {
  project: {
    name: string
    description: string
  }
  context: {
    architecture: string    // 关键架构决策
    conventions: string     // 代码风格和命名约定
  }
  milestones: Array<{
    id: string              // "M1", "M2", etc.
    name: string            // "Project Setup"
    description: string     // 为什么需要这个 milestone
    tasks: Array<{
      id: string            // "001", "002", etc.
      title: string         // 简短标题
      description: string   // 详细描述
      verification: string  // 验证标准
      depends: string[]     // 依赖任务 ID
    }>
  }>
}
```

---

## 参考文档

- [CONFIG-DRIVEN.md](../BACKEND/CONFIG-DRIVEN.md) - Prompt 模板格式
- [DOMAIN.md](../BACKEND/DOMAIN.md) - Domain Engines
- [INTERFACES.md](../BACKEND/INTERFACES.md) - IClaudeAdapter
- [IPC.md](../IPC/IPC.md) - IPC 通道定义
