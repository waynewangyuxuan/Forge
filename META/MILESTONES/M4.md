# M4: Scaffold 生成

> **目标**：实现 Spec → TODO.md + CLAUDE.md 的 AI 生成

**状态**: completed
**依赖**: M3

---

## 架构决策

基于 M4 开发前的咨询反馈，做出以下决策：

| 决策 | 选择 | 原因 |
|------|------|------|
| AI 输出格式 | **JSON** | 比 Markdown 更易解析和验证 |
| 文件拆分 | **代码处理** | 不依赖 AI 创建文件，更可控 |
| 文档分层 | **索引 + 详情** | 执行时按需加载，节省 context |
| 执行协议 | **显式步骤** | 确保 Claude Code 按需读取文件 |

## 输出文件结构

```
META/
├── CLAUDE.md           # 执行入口（~800 tokens）
├── TODO.md             # 任务索引（~1K tokens）
├── MILESTONES/         # 按 Milestone 分文件
│   ├── M1-*.md
│   ├── M2-*.md
│   └── ...
└── CONTEXT/            # 执行时按需加载
    ├── architecture.md
    └── conventions.md
```

---

## 交付物

### 后端

- [x] ClaudeCliAdapter（调用 Claude Code CLI）
  - `src/main/infrastructure/adapters/claude.adapter.ts`
- [x] Domain Engines
  - [x] PromptRenderer（渲染 prompt 模板） - `src/main/domain/engines/prompt-renderer.ts`
  - [x] ScaffoldValidator（验证 JSON 结构） - `src/main/domain/engines/scaffold-validator.ts`
  - [x] ScaffoldWriter（JSON → 文件） - `src/main/domain/engines/scaffold-writer.ts`
- [x] Config 文件
  - [x] `config/prompts/scaffold-generator.yaml`
  - [x] `config/templates/claude-md.template.md`
- [x] Scaffold Use Cases
  - [x] `src/main/application/use-cases/scaffold/generate-scaffold.ts`
- [x] scaffold:* IPC 事件发送
  - `src/main/infrastructure/ipc/scaffold.ipc.ts`

### 前端

- [x] RealtimeStore scaffold 订阅 - 已在 M3 实现
- [x] SpecPage "Generate Scaffold" 按钮
- [x] 生成进度展示（Modal + 流式消息）
- [x] 生成完成后自动跳转 ReviewPage

---

## 验收标准

- [x] 点击 Generate 后能看到实时进度消息
- [x] 生成完成后 TODO.md 出现在 META/
- [x] 生成完成后 CLAUDE.md 出现在 META/
- [x] 生成完成后 MILESTONES/*.md 出现在 META/
- [x] 生成完成后 CONTEXT/*.md 出现在 META/
- [x] Version 状态从 `drafting` → `scaffolding` → `reviewing`
- [x] 生成失败时显示错误信息
- [x] Claude CLI 不可用时有明确提示

---

## IPC 通道

| 类型 | 通道 | 说明 |
|------|------|------|
| Invoke | `scaffold:generate` | 触发生成 |
| Invoke | `scaffold:checkClaudeAvailable` | 检查 Claude CLI 可用性 |
| Event | `scaffold:progress` | 进度消息 |
| Event | `scaffold:completed` | 生成完成 |
| Event | `scaffold:error` | 生成出错 |

---

## 状态流转

```
drafting ──[GENERATE_SCAFFOLD]──► scaffolding ──[SUCCESS]──► reviewing
                                       │
                                       └──[ERROR]──► drafting
```

---

## AI 输出 JSON Schema

```typescript
interface ScaffoldOutput {
  project: {
    name: string
    description: string
  }
  context: {
    architecture: string    // 关键架构决策
    conventions: string     // 代码风格和命名约定
  }
  milestones: Array<{
    id: string              // "M1", "M2", etc.
    name: string            // "Project Setup"
    description: string     // 为什么需要这个 milestone
    tasks: Array<{
      id: string            // "001", "002", etc.
      title: string         // 简短标题
      description: string   // 详细描述
      verification: string  // 验证标准
      depends: string[]     // 依赖任务 ID
    }>
  }>
}
```

---

## 参考文档

- [CONFIG-DRIVEN.md](../BACKEND/CONFIG-DRIVEN.md) - Prompt 模板格式
- [DOMAIN.md](../BACKEND/DOMAIN.md) - Domain Engines
- [INTERFACES.md](../BACKEND/INTERFACES.md) - IClaudeAdapter
- [IPC.md](../IPC/IPC.md) - IPC 通道定义
