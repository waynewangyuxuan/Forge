# M6: 代码执行

> **目标**：实现按任务执行代码生成

**状态**: pending
**依赖**: M5

---

## 交付物

### 后端

- [ ] Domain Engines
  - [ ] PlanCalculator（计算下一个任务）
- [ ] Application Services
  - [ ] ExecutionOrchestrator（执行编排）
- [ ] Config 文件
  - [ ] config/prompts/code-executor.yaml
- [ ] Execution Use Cases
  - [ ] start-execution.ts
  - [ ] pause-execution.ts
  - [ ] resume-execution.ts
  - [ ] abort-execution.ts
  - [ ] retry-task.ts
  - [ ] skip-task.ts
  - [ ] get-execution-status.ts
- [ ] execution.ipc.ts
- [ ] sqlite-execution.repo.ts

### 前端

- [ ] RealtimeStore execution 订阅
- [ ] ExecutePage 页面
- [ ] TaskItem 组件（带执行状态）
- [ ] ProgressBar 组件
- [ ] 控制按钮（Start/Pause/Resume/Abort）
- [ ] 失败处理 UI（Retry/Skip）

---

## 验收标准

- [ ] 点击 Start 后任务逐个执行
- [ ] 进度条实时更新（completed/total）
- [ ] 当前执行任务高亮显示
- [ ] 能暂停执行，暂停后可恢复
- [ ] 能中止执行
- [ ] 任务失败时显示错误，可 Retry 或 Skip
- [ ] 全部完成后 Version 状态变为 `completed`
- [ ] 代码正确生成到项目 src/ 目录

---

## IPC 通道

| 类型 | 通道 | 说明 |
|------|------|------|
| Invoke | `execution:start` | 开始执行 |
| Invoke | `execution:pause` | 暂停 |
| Invoke | `execution:resume` | 恢复 |
| Invoke | `execution:abort` | 中止 |
| Invoke | `execution:retry` | 重试任务 |
| Invoke | `execution:skip` | 跳过任务 |
| Invoke | `execution:getStatus` | 获取状态 |
| Event | `execution:progress` | 进度更新 |
| Event | `execution:taskStart` | 任务开始 |
| Event | `execution:taskDone` | 任务完成 |
| Event | `execution:taskFailed` | 任务失败 |
| Event | `execution:paused` | 已暂停 |
| Event | `execution:resumed` | 已恢复 |
| Event | `execution:completed` | 全部完成 |
| Event | `execution:error` | 执行出错 |

---

## 执行流程

```
┌─────────────────────────────────────────────────────┐
│                 ExecutionOrchestrator                │
├─────────────────────────────────────────────────────┤
│                                                     │
│  1. 加载 ExecutionPlan                              │
│  2. while (有未完成任务 && !paused && !aborted):    │
│     a. PlanCalculator.getNextTask()                 │
│     b. 发送 taskStart 事件                          │
│     c. ClaudeAdapter.execute(task, prompt)          │
│     d. 成功 → 发送 taskDone，更新状态               │
│        失败 → 发送 taskFailed，等待用户决策         │
│     e. 发送 progress 事件                           │
│  3. 全部完成 → 发送 completed 事件                  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 状态流转

```
ready ──[START]──► executing ──[ALL_COMPLETE]──► completed
                       │
                       ├──[PAUSE]──► paused ──[RESUME]──► executing
                       │
                       ├──[ABORT]──► aborted
                       │
                       └──[TASK_FAIL]──► error ──[RETRY/SKIP]──► executing
```

---

## 参考文档

- [DOMAIN.md](../BACKEND/DOMAIN.md) - PlanCalculator
- [OVERVIEW.md](../BACKEND/OVERVIEW.md) - ExecutionOrchestrator
- [IPC.md](../IPC/IPC.md) - 2.5 Execution, 3.2 Execution Events
