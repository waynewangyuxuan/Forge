# M7: Runtime 运行

> **目标**：实现项目运行管理

**状态**: pending
**依赖**: M6

---

## 交付物

### 后端

- [ ] Infrastructure Adapters
  - [ ] SchedulerAdapter（node-cron）
  - [ ] KeychainAdapter（keytar）
- [ ] Application Services
  - [ ] RuntimeManager
- [ ] Runtime Use Cases
  - [ ] configure-runtime.ts
  - [ ] get-runtime-config.ts
  - [ ] trigger-run.ts
  - [ ] stop-run.ts
  - [ ] get-runtime-status.ts
  - [ ] get-run-history.ts
  - [ ] get-run-logs.ts
- [ ] Credentials Use Cases
  - [ ] list-credentials.ts
  - [ ] add-credential.ts
  - [ ] update-credential.ts
  - [ ] delete-credential.ts
- [ ] runtime.ipc.ts
- [ ] credentials.ipc.ts
- [ ] sqlite-run.repo.ts
- [ ] Credentials → .env.local 生成逻辑

### 前端

- [ ] RealtimeStore run 订阅
- [ ] RuntimePage 页面
  - [ ] RuntimeConfig 表单
  - [ ] triggerType 选择（manual/schedule/always_running）
  - [ ] cron 表达式输入
  - [ ] credentials 映射配置
- [ ] RunHistoryList 组件
- [ ] LogViewer 组件（实时日志）
- [ ] SettingsPage - 全局 Credentials 管理

---

## 验收标准

- [ ] 能配置 Manual 模式，手动触发运行
- [ ] 能配置 Schedule 模式，按 cron 自动运行
- [ ] 能配置 Always-running 模式，启动后持续运行
- [ ] Always-running 模式支持健康检查
- [ ] 能添加/编辑/删除全局 Credentials
- [ ] 能在 RuntimeConfig 中映射 Credentials 到环境变量
- [ ] Run 触发时正确生成 .env.local
- [ ] 运行日志实时显示
- [ ] 运行历史正确记录并可查看

---

## IPC 通道

| 类型 | 通道 | 说明 |
|------|------|------|
| Invoke | `runtime:configure` | 配置运行方式 |
| Invoke | `runtime:getConfig` | 获取配置 |
| Invoke | `runtime:trigger` | 手动触发 |
| Invoke | `runtime:stop` | 停止运行 |
| Invoke | `runtime:getStatus` | 获取状态 |
| Invoke | `runtime:getHistory` | 获取历史 |
| Invoke | `runtime:getLogs` | 获取日志 |
| Invoke | `credentials:list` | 列出凭证 |
| Invoke | `credentials:add` | 添加凭证 |
| Invoke | `credentials:update` | 更新凭证 |
| Invoke | `credentials:delete` | 删除凭证 |
| Event | `runtime:started` | 运行开始 |
| Event | `runtime:log` | 日志输出 |
| Event | `runtime:completed` | 运行结束 |
| Event | `runtime:healthUpdate` | 健康状态 |

---

## Credentials 解析流程

```
1. 读取 runtime_configs.credentials 映射
2. 解析每个 CredentialRef：
   - { type: 'global', nickname } → 从 Keychain 获取
   - { type: 'project', value } → 直接使用
3. 生成 .env.local：
   ENV_NAME_1=resolved_value_1
   ENV_NAME_2=resolved_value_2
4. run.sh: source .env.local
```

---

## RuntimeConfig UI

```
┌─────────────────────────────────────────────┐
│ Runtime Configuration                        │
├─────────────────────────────────────────────┤
│                                             │
│ Trigger Type:  ○ Manual                     │
│                ● Schedule                   │
│                ○ Always Running             │
│                                             │
│ Cron Expression: [0 9 * * *    ] (每天9点)  │
│                                             │
│ Environment Variables:                      │
│ ┌─────────────┬────────────────────────┐   │
│ │ NOTION_KEY  │ [Global: my-notion]  ▼│   │
│ │ API_SECRET  │ [Project: ********]  ▼│   │
│ └─────────────┴────────────────────────┘   │
│                              [+ Add]        │
│                                             │
│                        [Save Configuration] │
└─────────────────────────────────────────────┘
```

---

## 参考文档

- [IPC.md](../IPC/IPC.md) - 2.6 Runtime, 2.8 Credentials
- [DATA-MODEL.md](../BACKEND/DATA-MODEL.md) - runtime_configs, runs, credentials 表
- [INTERFACES.md](../BACKEND/INTERFACES.md) - ISchedulerAdapter, IKeychainAdapter
